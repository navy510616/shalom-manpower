import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

let currentDate = new Date();
let zoomLevel = 1;

export function initSummary() {
    console.log("‚úÖ initSummary Ïã§ÌñâÎê®");
    updateDateDisplay();
    setupControls();
    enableArrowNavigation();
    enableColorPicker();
    loadDataFromFirebase();  // üîÅ Ï¥àÍ∏∞ Î°úÎî© Ïãú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
}

function updateDateDisplay() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;

    const yearEl = document.getElementById('yearDisplay');
    const monthEl = document.getElementById('monthDisplay');

    if (yearEl && monthEl) {
        yearEl.textContent = year;
        monthEl.textContent = month;
    }

    const theadRow = document.querySelector('#summaryTable thead tr');
    if (!theadRow) return;

    while (theadRow.children.length > 3) {
        theadRow.removeChild(theadRow.children[2]);
    }

    const days = new Date(year, month, 0).getDate();
    const remarkTh = theadRow.lastElementChild;

    // ‚úÖ Í≥†Ï†ï ÎÑàÎπÑ ÏÑ§Ï†ï
    theadRow.children[0].className = 'checkbox-col'; // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïó¥
    theadRow.children[1].className = 'name-col'; // Ïù¥Î¶Ñ Ïó¥
    remarkTh.className = 'remark-col'; // ÎπÑÍ≥† Ïó¥

    for (let i = 1; i <= days; i++) {
        const th = document.createElement('th');
        th.textContent = i;
        th.className = 'day-col';
        theadRow.insertBefore(th, remarkTh);
    }

    const rows = document.querySelectorAll('#summaryTable tbody tr');
    rows.forEach(row => {
        while (row.children.length > 3) {
            row.removeChild(row.children[2]);
        }

        row.children[0].className = 'checkbox-col';
        row.children[1].className = 'name-col';
        row.lastElementChild.className = 'remark-col';

        for (let i = 1; i <= days; i++) {
            const td = document.createElement('td');
            td.contentEditable = true;
            td.className = 'day-col';
            row.insertBefore(td, row.lastElementChild);
        }
    });
}

function setupControls() {
    const qs = id => document.getElementById(id);

    qs('prevMonthBtn')?.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateDateDisplay();
        loadDataFromFirebase();
    });

    qs('nextMonthBtn')?.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateDateDisplay();
        loadDataFromFirebase();
    });

    qs('addNameBtn')?.addEventListener('click', addNameRow);
    qs('deleteRowBtn')?.addEventListener('click', deleteSelectedRows);
    qs('sortAscBtn')?.addEventListener('click', sortByNameAsc);
    qs('sortDescBtn')?.addEventListener('click', sortByNameDesc);
    qs('zoomInBtn')?.addEventListener('click', () => {
        zoomLevel += 0.1;
        qs('summaryTable').style.transform = `scale(${zoomLevel})`;
    });
    qs('zoomOutBtn')?.addEventListener('click', () => {
        zoomLevel = Math.max(0.5, zoomLevel - 0.1);
        qs('summaryTable').style.transform = `scale(${zoomLevel})`;
    });

    qs('importBtn')?.addEventListener('click', () => {
        qs('importExcel').click();
    });
    qs('importExcel')?.addEventListener('change', handleFileUpload);
    qs('exportBtn')?.addEventListener('click', exportToExcel);
    qs('saveBtn')?.addEventListener('click', saveData);
    qs('highlightBtn')?.addEventListener('click', () => {
        const active = document.activeElement;
        if (active && active.tagName === 'TD' && active.isContentEditable) {
            active.classList.toggle('selected-cell');
        }
    });
}

function enableArrowNavigation() {
    document.addEventListener('keydown', e => {
        const active = document.activeElement;
        if (!active || active.tagName !== 'TD' || !active.isContentEditable) return;

        const cell = active;
        const row = cell.parentElement;
        const tbody = document.querySelector('#summaryTable tbody');

        const rowIndex = Array.from(tbody.rows).indexOf(row);
        const cellIndex = Array.from(row.children).indexOf(cell);

        let targetCell = null;

        switch (e.key) {
            case 'ArrowLeft':
                if (cell.previousElementSibling) {
                    targetCell = cell.previousElementSibling;
                }
                break;
            case 'ArrowRight':
                if (cell.nextElementSibling) {
                    targetCell = cell.nextElementSibling;
                }
                break;
            case 'ArrowUp':
                if (rowIndex > 0) {
                    const prevRow = tbody.rows[rowIndex - 1];
                    targetCell = prevRow.children[cellIndex];
                }
                break;
            case 'ArrowDown':
                if (rowIndex < tbody.rows.length - 1) {
                    const nextRow = tbody.rows[rowIndex + 1];
                    targetCell = nextRow.children[cellIndex];
                }
                break;
            case 'Enter':
                e.preventDefault();
                if (rowIndex < tbody.rows.length - 1) {
                    const nextRow = tbody.rows[rowIndex + 1];
                    targetCell = nextRow.children[cellIndex];
                }
                break;
        }

        if (targetCell && targetCell.isContentEditable) {
            e.preventDefault();
            targetCell.focus();
        }
    });
}

function addNameRow() {
    const tbody = document.querySelector('#summaryTable tbody');
    const days = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    const row = document.createElement('tr');
    row.innerHTML = `
    <td><input type="checkbox" /></td>
    <td contenteditable="true">Ïù¥Î¶Ñ</td>
    ${Array.from({ length: days }, () => '<td contenteditable="true" class="day-col"></td>').join('')}
    <td contenteditable="true"></td>
  `;
    tbody.appendChild(row);
}

function deleteSelectedRows() {
    document.querySelectorAll('#summaryTable tbody tr')
        .forEach(row => {
            if (row.querySelector('input[type="checkbox"]')?.checked) {
                row.remove();
            }
        });
}

function sortByNameAsc() {
    const tbody = document.querySelector('#summaryTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => (a.cells[1]?.textContent ?? '').localeCompare(b.cells[1]?.textContent ?? '', 'ko'));
    rows.forEach(row => tbody.appendChild(row));
}

function sortByNameDesc() {
    const tbody = document.querySelector('#summaryTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => (b.cells[1]?.textContent ?? '').localeCompare(a.cells[1]?.textContent ?? '', 'ko'));
    rows.forEach(row => tbody.appendChild(row));
}

function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });

        const tbody = document.querySelector('#summaryTable tbody');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const days = new Date(year, month, 0).getDate();

        tbody.innerHTML = '';

        rows.slice(1).forEach(row => {
            if (!row[0]) return; // Ïù¥Î¶ÑÏù¥ ÏóÜÏúºÎ©¥ skip

            const tr = document.createElement('tr');
            const name = row[0];
            const dayData = row.slice(1, days + 1);
            const remark = row.length > days + 1 ? row[days + 1] : '';

            const dayCells = [];

            for (let i = 0; i < days; i++) {
                dayCells.push(`<td contenteditable="true">${dayData[i] ?? ''}</td>`);
            }

            tr.innerHTML = `
                <td><input type="checkbox" /></td>
                <td contenteditable="true">${name}</td>
                ${dayCells.join('')}
                <td contenteditable="true">${remark ?? ''}</td>
            `;

            tbody.appendChild(tr);
        });
    };
    reader.readAsArrayBuffer(file);
}

function exportToExcel() {
    const table = document.getElementById('summaryTable');
    const wb = XLSX.utils.book_new();
    const ws_data = [];

    // Ìó§Îçî ÏàòÏßë
    const headerCells = Array.from(table.querySelectorAll('thead th')).slice(1); // ‚úÖ Ï≤´ Ïπ∏ Ï†úÏô∏
    ws_data.push(headerCells.map(th => th.textContent));

    // Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(tr => {
        const tds = Array.from(tr.children).slice(1); // ‚úÖ Ï≤´ Î≤àÏß∏ Ïπ∏ Ï†úÏô∏ (checkbox)
        const rowData = tds.map(td => td.textContent.trim());
        ws_data.push(rowData);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'ÏõîÎßêÏ†ïÎ¶¨');
    XLSX.writeFile(wb, 'summary.xlsx');
}

async function saveData() {
    await saveDataToFirebase();
}

// ‚úÖ ÏÖÄ ÏÉâÏÉÅ ÏÑ†ÌÉù Í∏∞Îä• Î∞è ÌåùÏóÖ UI Ìè¨Ìï® (16ÏÉâ ÌôïÏû• + z-index Î≥¥Ï†ï)
export function enableColorPicker() {
    const table = document.getElementById('summaryTable');
    const highlightBtn = document.getElementById('highlightBtn');

    if (!table || !highlightBtn) {
        console.warn('‚ùå Ìëú ÎòêÎäî highlightBtn ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
        return;
    }

    let selectedCells = new Set();
    let isMouseDown = false;
    let startCell = null;

    table.addEventListener('mousedown', e => {
        if (e.target.tagName === 'TD' && e.target.isContentEditable) {
            isMouseDown = true;
            startCell = e.target;
            clearSelection();
            toggleCellSelection(e.target);
        }
    });

    table.addEventListener('mouseover', e => {
        if (isMouseDown && startCell && e.target.tagName === 'TD' && e.target.isContentEditable) {
            clearSelection();
            selectCellRange(startCell, e.target);
        }
    });

    document.addEventListener('mouseup', () => {
        isMouseDown = false;
        startCell = null;
    });

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            clearSelection();
            popup.style.display = 'none';
        }

        // ‚úÖ Delete ÌÇ§Î°ú ÏÑ†ÌÉù ÏÖÄ ÎÇ¥Ïö© ÏÇ≠Ï†ú
        if (e.key === 'Delete') {
            selectedCells.forEach(cell => {
                cell.textContent = '';
            });
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('#summaryTable') && !e.target.closest('.color-picker-popup') && !e.target.closest('#highlightBtn')) {
            popup.style.display = 'none';
            clearSelection();
        }
    });

    document.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'TD' && e.target.isContentEditable) {
            const td = e.target;
            // Shift ÏÑ†ÌÉùÏù¥ ÏïÑÎãàÎ©¥ Î™®Îëê Ìï¥Ï†ú
            if (!e.shiftKey) {
                document.querySelectorAll('.cell-selected').forEach(el => el.classList.remove('cell-selected'));
            }
            td.classList.toggle('cell-selected');
        }
    });

    function toggleCellSelection(cell) {
        if (!selectedCells.has(cell)) {
            cell.classList.add('selected');
            selectedCells.add(cell);
        }
    }

    function clearSelection() {
        selectedCells.forEach(cell => cell.classList.remove('selected'));
        selectedCells.clear();
    }

    function selectCellRange(start, end) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);

        const startRow = rows.indexOf(start.parentElement);
        const endRow = rows.indexOf(end.parentElement);
        const startCol = Array.from(start.parentElement.cells).indexOf(start);
        const endCol = Array.from(end.parentElement.cells).indexOf(end);

        const rowMin = Math.min(startRow, endRow);
        const rowMax = Math.max(startRow, endRow);
        const colMin = Math.min(startCol, endCol);
        const colMax = Math.max(startCol, endCol);

        for (let i = rowMin; i <= rowMax; i++) {
            const row = rows[i];
            for (let j = colMin; j <= colMax; j++) {
                const cell = row.cells[j];
                if (cell && cell.isContentEditable) {
                    cell.classList.add('selected');
                    selectedCells.add(cell);
                }
            }
        }
    }

    // ÏÉâÏÉÅ ÏÑ†ÌÉù ÌåùÏóÖ ÏÉùÏÑ± (16ÏÉâ + Ï¥àÍ∏∞Ìôî Î≤ÑÌäº)
    const popup = document.createElement('div');
    popup.className = 'color-picker-popup';
    popup.style.display = 'none';
    popup.style.flexWrap = 'wrap';
    popup.style.width = '180px';
    popup.style.padding = '6px';
    popup.style.background = '#fff';
    popup.style.border = '1px solid #ccc';
    popup.style.borderRadius = '6px';
    popup.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    popup.style.position = 'absolute';
    popup.style.zIndex = '9999';

    const colors = [
        '#ffffff', '#f8f9fa', '#ffeeba', '#d4edda', '#bee5eb', '#f5c6cb', '#d6d8db', '#c3e6cb',
        '#b8daff', '#f5b7b1', '#f0e68c', '#d1ecf1', '#e2e3e5', '#f9f7f7', '#fdfd96', '#ffb3ba',
        '#ffcccb', '#ccffcc', '#ccffff', '#ccccff', '#ffccff', '#f0fff0', '#e6e6fa', '#ffe4e1',
        '#fafad2', '#f0f8ff', '#f5fffa', '#d3d3d3', '#fdf5e6', '#f0ffff', '#ffe4b5', '#e0ffff'
    ];

    colors.forEach(hex => {
        const swatch = document.createElement('div');
        swatch.style.backgroundColor = hex;
        swatch.style.width = '24px';
        swatch.style.height = '24px';
        swatch.style.border = '1px solid #ccc';
        swatch.style.borderRadius = '4px';
        swatch.style.margin = '4px';
        swatch.style.cursor = 'pointer';

        swatch.addEventListener('click', () => {
            selectedCells.forEach(cell => {
                cell.style.backgroundColor = hex;
            });
            popup.style.display = 'none';
        });
        popup.appendChild(swatch);
    });

    // ‚úÖ Ï¥àÍ∏∞Ìôî Î≤ÑÌäº
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'Ï±ÑÏö∞Í∏∞ ÏóÜÏùå';
    clearBtn.style.marginTop = '4px';
    clearBtn.style.padding = '4px 8px';
    clearBtn.style.fontSize = '12px';
    clearBtn.style.border = '1px solid #ccc';
    clearBtn.style.borderRadius = '4px';
    clearBtn.style.background = '#f8f9fa';
    clearBtn.style.cursor = 'pointer';
    clearBtn.addEventListener('click', () => {
        selectedCells.forEach(cell => {
            cell.style.backgroundColor = '#f9f9f9';
        });
        popup.style.display = 'none';
    });
    popup.appendChild(clearBtn);

    document.body.appendChild(popup);

    // Ïù¥Î™®ÏßÄ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌåùÏóÖ ÌëúÏãú (Ï†ÅÏ†àÌïú ÏúÑÏπò Í≥ÑÏÇ∞)
    highlightBtn.addEventListener('click', e => {
        const rect = highlightBtn.getBoundingClientRect();
        popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
        popup.style.left = `${Math.min(rect.left + window.scrollX, window.innerWidth - 200)}px`;
        popup.style.display = 'flex';
        popup.style.visibility = 'visible';
        popup.focus();
    });
}

import {
    getFirestore, doc, getDoc, setDoc
} from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

const db = getFirestore(); // Ïù¥ÎØ∏ monthly.jsÏóêÏÑú Ï¥àÍ∏∞ÌôîÎê®

async function saveDataToFirebase() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    const table = document.querySelector('#summaryTable');
    const rows = table.querySelectorAll('tbody tr');

    const summaryData = [];

    rows.forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        const name = cells[1]?.textContent.trim() || '';
        const row = [];

        for (let i = 2; i < cells.length; i++) {
            row.push({
                value: cells[i].textContent.trim(),
                color: cells[i].style.backgroundColor || ''
            });
        }

        summaryData.push({ name, data: row });
    });

    try {
        await setDoc(doc(db, 'summary', `${year}-${month}`), {
            year,
            month,
            rows: summaryData,
        });
        toast('‚úÖ Ï†ÄÏû• ÏôÑÎ£å');
    } catch (err) {
        console.error('‚ùå Ï†ÄÏû• Ïã§Ìå®:', err);
    }
}

document.getElementById('saveBtn')?.addEventListener('click', saveDataToFirebase);

async function loadDataFromFirebase() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    const key = `${year}-${month}`;
    const docRef = doc(db, 'summary', key);

    try {
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            console.warn('‚ùó Î∂àÎü¨Ïò¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }

        const { rows } = docSnap.data();
        const tbody = document.querySelector('#summaryTable tbody');
        const days = new Date(year, month, 0).getDate();

        tbody.innerHTML = '';

        rows.forEach(({ name, data }) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" /></td>
                <td contenteditable="true">${name}</td>
                ${data.slice(0, days).map(cell => `
                <td contenteditable="true" class="day-col" style="background-color: ${cell.color || ''}">
                    ${cell.value || ''}
                </td>`).join('')}
                <td contenteditable="true"></td> <!-- ÎπÑÍ≥† -->
            `;
            tbody.appendChild(tr);
        });

        console.log('‚úÖ FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å');
    } catch (err) {
        console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', err);
    }
}

function toast(msg) {
    const d = document.createElement('div');
    Object.assign(d.style, {
        position: 'fixed',
        top: '30px',
        left: '50%',
        transform: 'translateX(-50%)',
        padding: '8px 16px',
        background: '#333',
        color: '#fff',
        borderRadius: '4px',
        zIndex: 9999,
        opacity: 0,
        transition: 'opacity .3s',
    });
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.style.opacity = 1, 10);
    setTimeout(() => {
        d.style.opacity = 0;
        setTimeout(() => d.remove(), 300);
    }, 1000);
}

export function reset() {
    console.log("üîÑ summary Î™®Îìà Ï¥àÍ∏∞ÌôîÎê®");
}

//ÏÖÄ Î≥ëÌï© Í∏∞Îä•
// function mergeSelectedCellsHorizontally() {
//     const selected = Array.from(document.querySelectorAll('.cell-selected'));
//     console.log('ÏÑ†ÌÉùÎêú ÏÖÄ:', selected);

//     if (selected.length < 2) {
//         alert('2Í∞ú Ïù¥ÏÉÅÏùò ÏÖÄÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
//         return;
//     }

//     // Í∞ôÏùÄ ÌñâÏù∏ÏßÄ ÌôïÏù∏
//     const row = selected[0].parentElement;
//     if (!selected.every(td => td.parentElement === row)) {
//         alert('Í∞ôÏùÄ ÌñâÏùò ÏÖÄÎßå Î≥ëÌï©Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
//         return;
//     }

//     const first = selected[0];
//     const colspan = selected.length;
//     // Í∏∞Ï°¥ ÏÖÄ ÌÖçÏä§Ìä∏ Í≤∞Ìï©
//     const mergedText = selected.map(td => td.textContent.trim()).join(' ');

//     // Ï≤´ ÏÖÄÏóê colspan ÏßÄÏ†ïÌïòÍ≥† ÎÇ¥Ïö© ÏÑ§Ï†ï
//     first.setAttribute('colspan', colspan);
//     first.textContent = mergedText;
//     first.classList.remove('cell-selected');

//     // ÎÇòÎ®∏ÏßÄ ÏÖÄ Ï†úÍ±∞
//     for (let i = 1; i < selected.length; i++) {
//         selected[i].remove();
//     }
// }

// document.getElementById('mergeHorizontalBtn')?.addEventListener('click', mergeSelectedCellsHorizontally);
